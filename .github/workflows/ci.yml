name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Check scripts
      run: shellcheck scripts/*.sh
    - name: Validate YAML
      run: yamllint infra/ docs/
    - name: Secret scanning with TruffleHog
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified
    - name: Secret scanning with Gitleaks
      uses: gitleaks/gitleaks-action@v2
      with:
        config-path: .gitleaks.toml

  rbac-validation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Validate RBAC manifests
      run: |
        kubectl apply --dry-run=client -f infra/k8s/rbac.yaml

  dependency-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    - name: Run cargo audit
      run: cargo install cargo-audit && cargo audit

  run-tests:
    runs-on: ubuntu-latest
    needs: [lint, dependency-scan]
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
    - name: Install dependencies (neuro-services)
      run: npm ci
      working-directory: ./neuro-services
    - name: Install dependencies (admin-node)
      run: npm ci
      working-directory: ./neuroswarm/admin-node
    - name: Install dependencies (neuro-web)
      run: npm ci
      working-directory: ./neuro-web
    - name: Run neuro-services tests with detectOpenHandles
      run: npm test -- --runInBand --detectOpenHandles
      working-directory: ./neuro-services
    - name: Run admin-node tests with detectOpenHandles
      run: npm test -- --runInBand --detectOpenHandles
      working-directory: ./neuroswarm/admin-node